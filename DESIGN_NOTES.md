# Design Notes / 開発メモ

このドキュメントは、本プロジェクトの開発過程・技術的な意思決定・学びをまとめたメモです。

完成物だけでなく、  
「なぜそう設計したか」「どこで問題が起き、どう解決したか」  
を残すことを目的としています。

---

## 1. プロジェクト基盤構築・SOC基盤初期実装

### 背景
昔オープンチャットサイトで、

- 連続投稿制限を回避している  
- BANされても戻ってきている  
- セッションやトークンの話をしている  

荒らしを見た経験から、「なぜそれができるのか」「どう検知・防御できるのか」を  
自分で再現・検証したいと考え、本プロジェクトを開始しました。

単なるチャットではなく、  
**SOC視点での検知・監視を組み込んだWebアプリケーション**を目標に設計しています。

---

### 実装した内容（現時点）

- FastAPI を用いた簡易チャットWebアプリの構築
- Redis を用いた状態管理（レート制限 / 一時ブロック / チャット保存）
- メッセージ投稿・取得APIの実装
- 連続投稿（荒らし想定）に対するレート制限
- 一定超過時の一時ブロック（TTL付きBAN）
- CSRF対策（Cookie + ヘッダトークン照合）
- セキュリティイベントのJSON Lines形式ログ出力（`logs/app.jsonl`）
- ログ監視用 runner プロセスの実装
- runner による不正挙動検知・Discord通知
- fetch による非同期送信への変更
- ブロック時の画面表示（赤バナー＋残り秒数表示）
- Redis障害時のエラーハンドリング（503で返す）

---

### 技術的なポイント・設計意図

#### ログ形式を JSONL にした理由
SOCで一般的な「構造化ログ」を意識し、

- 機械処理しやすい
- 追記のみで破損しにくい
- 監視プロセスから読みやすい

という点を重視しました。

#### Webアプリと監視runnerを分離した理由
実際のSOC構成を意識し、  
「サービス」と「監視・検知」を別プロセスとして設計しました。

#### IP/UserAgentをハッシュ化して記録した理由
個人情報を直接残さず、分析可能性と安全性を両立するためです。

---

### 発生した問題と対応

- Windows環境でテンプレートの文字コードエラーが発生  
  → Shift_JIS保存が原因だったため、UTF-8に統一して解決。

- fetch化後、ブロックが画面に反映されなくなった  
  → RedirectResponseが画面遷移を伴わないことが原因。  
    JSONレスポンス設計に変更し、フロント側で状態制御。

- ブロック通知が来るのに実際はブロックされていなかった  
  → Redisの中身を直接確認し、キー生成の不具合を特定。  
    TTLを確認できるデバッグエンドポイントを作成し、検証・修正。

---

### 学んだこと

- 「検知されている」と「防御できている」は別であること
- Redisなど外部状態は、必ず実データを確認する重要性
- fetch導入により、バックエンド設計とフロント挙動が密接に関係すること
- セキュリティ機能は「UI」「制御」「ログ」「監視」が揃って初めて意味を持つこと

---

### 現在の到達点

- 荒らし行為（連続投稿）を想定した **検知・制御・通知** の一連の流れが完成
- 「検知 → ログ → 監視 → 外部通知」を通した簡易SOCモデルが構築できた

---

## 今後の予定

- 管理者用画面の実装（BAN/UNBAN・監視ビュー）
- 相関ID（request_id）の導入
- セキュリティイベントの分類・優先度付けの改善
